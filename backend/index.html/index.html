<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>XinChat Admin Pro</title>
    <link rel="stylesheet" href="https://unpkg.com/antd@5.27.0/dist/reset.css" />
    <style>
      html, body, #root { height: 100%; }
      body {
        margin: 0;
        background: radial-gradient(circle at 10% 10%, #edf7ff 0%, #f4fbf5 45%, #ffffff 100%);
        font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
      }
      .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Courier New', monospace; }
      .glass { background: linear-gradient(135deg, rgba(255,255,255,0.88), rgba(244,250,255,0.95)); backdrop-filter: blur(5px); }
      .resp {
        white-space: pre-wrap;
        word-break: break-word;
        background: #0b1020;
        color: #dbeafe;
        border-radius: 10px;
        padding: 12px;
        max-height: 420px;
        overflow: auto;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script>if (!window.React) { document.write('<script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"><\\/script>'); }</script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script>if (!window.ReactDOM) { document.write('<script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"><\\/script>'); }</script>
    <script src="https://unpkg.com/dayjs@1/dayjs.min.js"></script>
    <script>if (!window.dayjs) { document.write('<script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"><\\/script>'); }</script>
    <script src="https://unpkg.com/antd@5.27.0/dist/antd.min.js"></script>
    <script>if (!window.antd) { document.write('<script src="https://cdn.jsdelivr.net/npm/antd@5.27.0/dist/antd.min.js"><\\/script>'); }</script>
    <script src="https://unpkg.com/@ant-design/icons@5.6.1/dist/index.umd.js"></script>
    <script>if (!window.icons) { document.write('<script src="https://cdn.jsdelivr.net/npm/@ant-design/icons@5.6.1/dist/index.umd.js"><\\/script>'); }</script>
    <script src="https://unpkg.com/@ant-design/pro-components@2.8.6/dist/pro-components.min.js"></script>
    <script>if (!window.ProComponents) { document.write('<script src="https://cdn.jsdelivr.net/npm/@ant-design/pro-components@2.8.6/dist/pro-components.min.js"><\\/script>'); }</script>
    <script src="https://unpkg.com/@babel/standalone@7.28.5/babel.min.js"></script>

    <script type="text/babel" data-presets="env,react">
      if (!window.React || !window.ReactDOM || !window.antd || !window.ProComponents || !window.icons) {
        const root = document.getElementById('root');
        if (root) {
          root.innerHTML = '<div style="padding:24px;font-family:Segoe UI,Microsoft YaHei,sans-serif;color:#b91c1c;">后台依赖加载失败，请刷新页面或关闭会注入脚本的浏览器扩展后重试。</div>';
        }
        throw new Error('Admin dependencies failed to load.');
      }
      const React = window.React;
      const ReactDOM = window.ReactDOM;
      const antd = window.antd;
      const ProComponents = window.ProComponents;
      const icons = window.icons;
      const { useState, useEffect, useMemo, useRef, useCallback } = React;
      const { ConfigProvider, Card, Row, Col, Space, Tag, Button, Input, InputNumber, Select, Form, Modal, Drawer, Alert, Popconfirm, Typography } = antd;
      const { ProLayout, PageContainer, ProTable, ProDescriptions } = ProComponents;
      const { DashboardOutlined, TeamOutlined, MessageOutlined, ApiOutlined, ReloadOutlined, EditOutlined, DeleteOutlined, EyeOutlined, StopOutlined } = icons;
      const { Text, Paragraph } = Typography;

      const types = ['text','image','video','voice','gif','file','card','call'];
      const reviewStatus = ['unreviewed','approved','flagged','blocked','deleted'];
      const riskLevels = ['low','medium','high'];

      const fmtNum = (v,d=0)=>Number.isFinite(Number(v))?Number(v).toLocaleString('zh-CN',{minimumFractionDigits:d,maximumFractionDigits:d}):'-';
      const fmtTime = (v)=>{ const d=new Date(v||''); return Number.isNaN(d.getTime())?'-':d.toLocaleString('zh-CN',{hour12:false}); };
      const fmtDur = (ms)=>{ const s=Math.max(0,Math.floor(Number(ms||0)/1000)); const h=Math.floor(s/3600); const m=Math.floor((s%3600)/60); const r=s%60; return h>0?`${h}h ${m}m ${r}s`:`${m}m ${r}s`; };
      const toTs = (v)=>{ if(!v) return ''; if(typeof v==='number') return String(v); if(typeof v==='string') return v; if(typeof v.valueOf==='function'){ const n=Number(v.valueOf()); return Number.isFinite(n)&&n>0?String(n):'';} return ''; };

      function App(){
        const [path,setPath] = useState('/dashboard');
        const [adminToken,setAdminToken] = useState(localStorage.getItem('xinchat_admin_token')||'');
        const [authToken,setAuthToken] = useState(localStorage.getItem('xinchat_auth_token')||'');
        const [refreshSec,setRefreshSec] = useState(Number(localStorage.getItem('xinchat_admin_refresh_seconds')||15));

        const [dash,setDash] = useState(null);
        const [dashLoading,setDashLoading] = useState(false);

        const [userKeys,setUserKeys] = useState([]);
        const [userOpen,setUserOpen] = useState(false);
        const [userDetail,setUserDetail] = useState(null);

        const [msgSummary,setMsgSummary] = useState(null);
        const [msgOpen,setMsgOpen] = useState(false);
        const [msgDetail,setMsgDetail] = useState(null);

        const [routes,setRoutes] = useState([]);
        const [routeId,setRouteId] = useState('');
        const [labMethod,setLabMethod] = useState('GET');
        const [labPath,setLabPath] = useState('/api/routes');
        const [labBody,setLabBody] = useState('');
        const [labResp,setLabResp] = useState('等待请求...');

        const userRef = useRef();
        const msgRef = useRef();
        const [userForm] = Form.useForm();
        const [msgForm] = Form.useForm();

        useEffect(()=>{ localStorage.setItem('xinchat_admin_token',adminToken||''); },[adminToken]);
        useEffect(()=>{ localStorage.setItem('xinchat_auth_token',authToken||''); },[authToken]);
        useEffect(()=>{ if(Number(refreshSec)>0) localStorage.setItem('xinchat_admin_refresh_seconds',String(refreshSec)); },[refreshSec]);

        const api = useCallback(async (url,{method='GET',body,admin=false,auth=false}={})=>{
          const headers={};
          if(admin && adminToken.trim()) headers['X-Admin-Token']=adminToken.trim();
          if(auth && authToken.trim()) headers['Authorization']=`Bearer ${authToken.trim()}`;
          if(body!==undefined) headers['Content-Type']='application/json';
          const res=await fetch(url,{method,headers:Object.keys(headers).length?headers:undefined,body:body===undefined?undefined:JSON.stringify(body)});
          const text=await res.text();
          let json; try{ json=JSON.parse(text);}catch{ json={success:false,message:text}; }
          if(!res.ok || !json?.success) throw new Error(String(json?.message||`HTTP ${res.status}`));
          return json.data;
        },[adminToken,authToken]);

        const loadDash = useCallback(async ()=>{
          setDashLoading(true);
          try{
            const [metrics,users,bottlenecks,messages]=await Promise.all([
              api('/api/admin/metrics'),
              api('/api/admin/users/summary',{admin:true}),
              api('/api/admin/bottlenecks',{admin:true}),
              api('/api/admin/messages/summary',{admin:true}),
            ]);
            setDash({metrics,users,bottlenecks,messages});
            setMsgSummary(messages);
          }catch(e){ antd.message.error(e.message); }
          finally{ setDashLoading(false); }
        },[api]);

        const loadRoutes = useCallback(async ()=>{
          try{
            const list = await api('/api/routes');
            const arr = Array.isArray(list)?list:[];
            setRoutes(arr);
            if(arr[0]){
              setRouteId(arr[0].id);
              setLabMethod(arr[0].method||'GET');
              const tpl = Array.isArray(arr[0].templates)&&arr[0].templates[0]?arr[0].templates[0]:null;
              setLabPath(tpl?.path||arr[0].path||'/api/routes');
              setLabBody(tpl?.body?JSON.stringify(tpl.body,null,2):'');
            }
          }catch(e){ antd.message.error(e.message); }
        },[api]);

        useEffect(()=>{ loadDash(); },[loadDash]);
        useEffect(()=>{ if(path==='/lab' && routes.length===0) loadRoutes(); if(path==='/messages') api('/api/admin/messages/summary',{admin:true}).then(setMsgSummary).catch(()=>{}); },[path]);

        useEffect(()=>{
          const sec=Math.max(5,Number(refreshSec)||15);
          const t=setInterval(()=>{
            if(path==='/dashboard') loadDash();
            if(path==='/users') userRef.current?.reload();
            if(path==='/messages'){ msgRef.current?.reload(); api('/api/admin/messages/summary',{admin:true}).then(setMsgSummary).catch(()=>{}); }
          },sec*1000);
          return ()=>clearInterval(t);
        },[path,refreshSec,loadDash,api]);
        const openUser = async(uid)=>{
          try{
            const d=await api(`/api/admin/users/detail?uid=${encodeURIComponent(uid)}`,{admin:true});
            setUserDetail(d);
            userForm.setFieldsValue({ uid:d.uid,nickname:d.nickname||'',signature:d.signature||'',domain:d.domain||'',status:d.status||'active',gender:d.gender||'',birthday:d.birthday||'',country:d.country||'',province:d.province||'',region:d.region||'' });
            setUserOpen(true);
          }catch(e){ antd.message.error(e.message); }
        };

        const saveUser = async()=>{
          try{
            const v=await userForm.validateFields();
            await api('/api/admin/users/update',{method:'POST',body:v,admin:true});
            antd.message.success('用户已更新');
            setUserOpen(false);
            userRef.current?.reload();
            loadDash();
          }catch(e){ if(!e?.errorFields) antd.message.error(e.message); }
        };

        const userBatch = async(action)=>{
          if(!userKeys.length) return antd.message.warning('请先选择用户');
          try{
            const r=await api('/api/admin/users/batch-action',{method:'POST',body:{action,uids:userKeys},admin:true});
            antd.message.success(`批量操作完成，变更 ${r.changed} 个账号`);
            setUserKeys([]); userRef.current?.reload();
          }catch(e){ antd.message.error(e.message); }
        };

        const revokeUser = async(uid)=>{ try{ await api('/api/admin/users/revoke-all',{method:'POST',body:{uid},admin:true}); antd.message.success('会话已下线'); userRef.current?.reload(); }catch(e){ antd.message.error(e.message);} };
        const softDeleteUser = async(uid,restore=false)=>{ try{ await api('/api/admin/users/soft-delete',{method:'POST',body:{uid,restore},admin:true}); antd.message.success(restore?'已恢复':'已软删除'); userRef.current?.reload(); }catch(e){ antd.message.error(e.message);} };

        const openMsg = async(id)=>{
          try{
            const d=await api(`/api/admin/messages/detail?id=${encodeURIComponent(id)}`,{admin:true});
            setMsgDetail(d);
            msgForm.setFieldsValue({ id:d.id,status:d.reviewStatus==='unreviewed'?'approved':d.reviewStatus,riskLevel:d.riskLevel||'low',reviewer:d.review?.reviewer||'',reason:d.review?.reason||'',tags:Array.isArray(d.review?.tags)?d.review.tags.join(','):'' });
            setMsgOpen(true);
          }catch(e){ antd.message.error(e.message); }
        };

        const saveMsg = async()=>{
          try{
            const v=await msgForm.validateFields();
            await api('/api/admin/messages/review',{method:'POST',body:{id:v.id,status:v.status,riskLevel:v.riskLevel,reviewer:v.reviewer||'',reason:v.reason||'',tags:v.tags||''},admin:true});
            antd.message.success('审查结果已保存');
            setMsgOpen(false);
            msgRef.current?.reload();
            setMsgSummary(await api('/api/admin/messages/summary',{admin:true}));
          }catch(e){ if(!e?.errorFields) antd.message.error(e.message); }
        };

        const delMsg = async(id)=>{ try{ await api('/api/admin/messages/delete',{method:'POST',body:{id,reason:'Admin review deletion'},admin:true}); antd.message.success('消息已删除'); msgRef.current?.reload(); setMsgSummary(await api('/api/admin/messages/summary',{admin:true})); }catch(e){ antd.message.error(e.message);} };

        const sendLab = async()=>{
          const method=String(labMethod||'GET').toUpperCase();
          const p=String(labPath||'').trim();
          if(!p.startsWith('/')) return antd.message.error('Path 必须以 / 开头');
          let body;
          if(labBody.trim()){ try{ body=JSON.parse(labBody);}catch{return antd.message.error('JSON Body 解析失败'); } }
          const headers={};
          if(p.startsWith('/api/admin') && adminToken.trim()) headers['X-Admin-Token']=adminToken.trim();
          if(authToken.trim()) headers['Authorization']=`Bearer ${authToken.trim()}`;
          if(body!==undefined) headers['Content-Type']='application/json';
          try{
            const res=await fetch(p,{method,headers:Object.keys(headers).length?headers:undefined,body:body===undefined?undefined:JSON.stringify(body)});
            setLabResp(`[${res.status}]\n${await res.text()}`);
          }catch(e){ setLabResp(`[ClientError]\n${e.message}`); }
        };

        const menus = useMemo(()=>[
          { path:'/dashboard', name:'运行概览', icon:<DashboardOutlined/> },
          { path:'/users', name:'用户管理', icon:<TeamOutlined/> },
          { path:'/messages', name:'消息审查', icon:<MessageOutlined/> },
          { path:'/lab', name:'扩展中心', icon:<ApiOutlined/> },
        ],[]);

        const userCols = [
          { title:'UID', dataIndex:'uid', search:false, width:110 },
          { title:'账号', dataIndex:'username' },
          { title:'昵称', dataIndex:'nickname' },
          { title:'状态', dataIndex:'status', valueType:'select', valueEnum:{all:{text:'all'},active:{text:'active'},blocked:{text:'blocked'},deleted:{text:'deleted'}}, render:(_,r)=> <Tag color={r.status==='active'?'success':r.status==='blocked'?'warning':'default'}>{r.status}</Tag> },
          { title:'在线', dataIndex:'online', search:false, width:90, render:(_,r)=> r.online?<Tag color='green'>online</Tag>:<Tag>offline</Tag> },
          { title:'令牌', dataIndex:'tokenCount', search:false, width:90 },
          { title:'好友', dataIndex:'friendsCount', search:false, width:90 },
          { title:'最后登录', dataIndex:'lastLoginAt', search:false, render:(_,r)=>fmtTime(r.lastLoginAt) },
          { title:'操作', valueType:'option', search:false, width:260, render:(_,r)=>[
            <Button key='e' size='small' icon={<EditOutlined/>} onClick={()=>openUser(r.uid)}>编辑</Button>,
            <Button key='o' size='small' icon={<StopOutlined/>} onClick={()=>revokeUser(r.uid)}>下线</Button>,
            r.status==='deleted'
              ? <Button key='rs' size='small' onClick={()=>softDeleteUser(r.uid,true)}>恢复</Button>
              : <Popconfirm key='sd' title='确认软删除该用户？' onConfirm={()=>softDeleteUser(r.uid,false)}><Button size='small' danger icon={<DeleteOutlined/>}>软删除</Button></Popconfirm>
          ] }
        ];

        const msgCols = [
          { title:'消息ID', dataIndex:'id', search:false, width:210, ellipsis:true, copyable:true },
          { title:'时间', dataIndex:'createdAt', search:false, width:170, render:(_,r)=>fmtTime(r.createdAt) },
          { title:'类型', dataIndex:'type', valueType:'select', valueEnum:Object.fromEntries(types.map(x=>[x,{text:x}])), width:100 },
          { title:'发送者', dataIndex:'senderUid', valueType:'digit', width:90 },
          { title:'目标', dataIndex:'targetUid', valueType:'digit', width:90 },
          { title:'会话', dataIndex:'targetType', valueType:'select', valueEnum:{private:{text:'private'},group:{text:'group'}}, width:100 },
          { title:'摘要', dataIndex:'preview', search:false, ellipsis:true, render:(_,r)=>r.preview||r.inspection?.textSample||'-' },
          { title:'风险', dataIndex:'riskLevel', valueType:'select', valueEnum:{low:{text:'low'},medium:{text:'medium'},high:{text:'high'}}, width:90, render:(_,r)=><Tag color={r.riskLevel==='high'?'red':r.riskLevel==='medium'?'orange':'green'}>{r.riskLevel}</Tag> },
          { title:'审查状态', dataIndex:'reviewStatus', valueType:'select', valueEnum:{all:{text:'all'},unreviewed:{text:'unreviewed'},approved:{text:'approved'},flagged:{text:'flagged'},blocked:{text:'blocked'},deleted:{text:'deleted'}}, width:130 },
          { title:'关键词', dataIndex:'q', hideInTable:true },
          { title:'起始时间', dataIndex:'startAt', hideInTable:true, valueType:'dateTime' },
          { title:'结束时间', dataIndex:'endAt', hideInTable:true, valueType:'dateTime' },
          { title:'操作', valueType:'option', search:false, width:170, render:(_,r)=>[
            <Button key='rv' size='small' icon={<EyeOutlined/>} onClick={()=>openMsg(r.id)}>审查</Button>,
            <Popconfirm key='rm' title='确认删除该消息？' onConfirm={()=>delMsg(r.id)}><Button size='small' danger icon={<DeleteOutlined/>}>删除</Button></Popconfirm>
          ] }
        ];
        const dashboardView = (
          <Space direction='vertical' size={16} style={{width:'100%'}}>
            <Row gutter={[16,16]}>
              <Col xs={24} sm={12} md={8} lg={6}><Card className='glass' loading={dashLoading}><Text type='secondary'>运行时长</Text><div style={{fontSize:24,fontWeight:600}}>{fmtDur(dash?.metrics?.uptimeMs||0)}</div></Card></Col>
              <Col xs={24} sm={12} md={8} lg={6}><Card className='glass' loading={dashLoading}><Text type='secondary'>在线用户</Text><div style={{fontSize:24,fontWeight:600}}>{fmtNum(dash?.users?.online||0)}</div></Card></Col>
              <Col xs={24} sm={12} md={8} lg={6}><Card className='glass' loading={dashLoading}><Text type='secondary'>用户总量</Text><div style={{fontSize:24,fontWeight:600}}>{fmtNum(dash?.users?.total||0)}</div></Card></Col>
              <Col xs={24} sm={12} md={8} lg={6}><Card className='glass' loading={dashLoading}><Text type='secondary'>消息总量</Text><div style={{fontSize:24,fontWeight:600}}>{fmtNum(dash?.messages?.messages?.total||0)}</div></Card></Col>
            </Row>
            <Card className='glass' title='消息审查汇总'>
              <Space wrap>
                <Tag color='blue'>总消息 {fmtNum(msgSummary?.messages?.total||0)}</Tag>
                <Tag color='cyan'>窗口消息 {fmtNum(msgSummary?.messages?.inWindow||0)}</Tag>
                <Tag color='orange'>flagged {fmtNum(msgSummary?.reviews?.byStatus?.flagged||0)}</Tag>
                <Tag color='red'>blocked {fmtNum(msgSummary?.reviews?.byStatus?.blocked||0)}</Tag>
              </Space>
            </Card>
            <Card className='glass' title='瓶颈建议'>
              {(dash?.bottlenecks?.recommendations||[]).map((x,i)=><Paragraph key={i} style={{marginBottom:8}}>{x}</Paragraph>)}
              {(!dash?.bottlenecks?.recommendations || dash.bottlenecks.recommendations.length===0) && <Text type='secondary'>暂无建议</Text>}
            </Card>
          </Space>
        );

        const usersView = (
          <ProTable
            actionRef={userRef}
            rowKey='uid'
            columns={userCols}
            request={async(params)=>{
              const q=new URLSearchParams();
              q.set('page',String(params.current||1));
              q.set('pageSize',String(params.pageSize||20));
              q.set('status',String(params.status||'all'));
              q.set('q',String(params.username||params.nickname||params.q||''));
              const d=await api(`/api/admin/users?${q.toString()}`,{admin:true});
              return {success:true,data:Array.isArray(d.items)?d.items:[],total:Number(d.total||0)};
            }}
            pagination={{pageSize:20,showSizeChanger:true}}
            rowSelection={{selectedRowKeys:userKeys,onChange:(keys)=>setUserKeys(keys)}}
            toolbar={{title:'支持批量封禁/恢复/下线，便于运营审查'}}
            toolBarRender={()=>[
              <Button key='r' icon={<ReloadOutlined/>} onClick={()=>userRef.current?.reload()}>刷新</Button>,
              <Button key='a' onClick={()=>userBatch('activate')}>批量激活</Button>,
              <Button key='b' danger onClick={()=>userBatch('block')}>批量封禁</Button>,
              <Button key='d' danger onClick={()=>userBatch('soft-delete')}>批量软删</Button>,
              <Button key='rs' onClick={()=>userBatch('restore')}>批量恢复</Button>,
              <Button key='rv' onClick={()=>userBatch('revoke-sessions')}>批量下线</Button>,
            ]}
          />
        );

        const messagesView = (
          <Space direction='vertical' style={{width:'100%'}} size={16}>
            <Card className='glass' size='small'>
              <Space wrap>
                <Tag color='blue'>总消息 {fmtNum(msgSummary?.messages?.total||0)}</Tag>
                <Tag color='orange'>flagged {fmtNum(msgSummary?.reviews?.byStatus?.flagged||0)}</Tag>
                <Tag color='red'>blocked {fmtNum(msgSummary?.reviews?.byStatus?.blocked||0)}</Tag>
                <Tag>deleted {fmtNum(msgSummary?.reviews?.byStatus?.deleted||0)}</Tag>
              </Space>
            </Card>
            <ProTable
              actionRef={msgRef}
              rowKey='id'
              columns={msgCols}
              request={async(params)=>{
                const q=new URLSearchParams();
                q.set('page',String(params.current||1));
                q.set('pageSize',String(params.pageSize||20));
                ['q','senderUid','targetUid','targetType','type','reviewStatus','riskLevel'].forEach((k)=>{
                  if(params[k]!==undefined && params[k]!==null && String(params[k]).trim()!=='') q.set(k,String(params[k]));
                });
                const s=toTs(params.startAt), e=toTs(params.endAt);
                if(s) q.set('startAt',s); if(e) q.set('endAt',e);
                const d=await api(`/api/admin/messages/search?${q.toString()}`,{admin:true});
                return {success:true,data:Array.isArray(d.items)?d.items:[],total:Number(d.total||0)};
              }}
              pagination={{pageSize:20,showSizeChanger:true}}
              toolbar={{title:'支持按 UID/类型/时间窗口检索，并直接审查与删除'}}
              toolBarRender={()=>[<Button key='r' icon={<ReloadOutlined/>} onClick={()=>msgRef.current?.reload()}>刷新</Button>]}
            />
          </Space>
        );

        const selectedRoute = routes.find((x)=>x.id===routeId) || null;
        const labView = (
          <Row gutter={[16,16]}>
            <Col xs={24} lg={8}>
              <Card title='接口目录' className='glass'>
                <Space direction='vertical' style={{width:'100%'}}>
                  <Button size='small' icon={<ReloadOutlined/>} onClick={loadRoutes}>刷新目录</Button>
                  {(routes||[]).map((r)=><Button key={r.id} type={routeId===r.id?'primary':'default'} style={{width:'100%',textAlign:'left'}} onClick={()=>{ setRouteId(r.id); setLabMethod(r.method||'GET'); const t=Array.isArray(r.templates)&&r.templates[0]?r.templates[0]:null; setLabPath(t?.path||r.path||'/'); setLabBody(t?.body?JSON.stringify(t.body,null,2):''); }}><span className='mono' style={{marginRight:8}}>{r.method}</span><span className='mono'>{r.path}</span></Button>)}
                </Space>
              </Card>
            </Col>
            <Col xs={24} lg={16}>
              <Card title='API Lab' className='glass'>
                <Space direction='vertical' style={{width:'100%'}} size={12}>
                  {selectedRoute && <Alert type='info' showIcon message={selectedRoute.note||'自定义调试'} />}
                  <Row gutter={8}>
                    <Col span={6}><Select value={labMethod} onChange={setLabMethod} style={{width:'100%'}} options={['GET','POST','PUT','PATCH','DELETE'].map(x=>({label:x,value:x}))} /></Col>
                    <Col span={18}><Input className='mono' value={labPath} onChange={(e)=>setLabPath(e.target.value)} /></Col>
                  </Row>
                  <Input.TextArea className='mono' rows={10} value={labBody} onChange={(e)=>setLabBody(e.target.value)} placeholder='JSON body' />
                  <Space><Button type='primary' onClick={sendLab}>发送请求</Button><Button onClick={()=>setLabResp('等待请求...')}>清空响应</Button></Space>
                  <pre className='resp mono'>{labResp}</pre>
                </Space>
              </Card>
              <Card title='扩展指引' className='glass' style={{marginTop:16}}>
                <Paragraph>页面按模块注册组织，新增后台能力只需增加路由并在菜单注册页面组件。</Paragraph>
                <Paragraph>当前示例模块：用户管理、消息审查、API Lab。可扩展举报中心、风控策略、运营活动模块。</Paragraph>
              </Card>
            </Col>
          </Row>
        );

        const page = { '/dashboard':dashboardView, '/users':usersView, '/messages':messagesView, '/lab':labView }[path] || dashboardView;

        return (
          <ConfigProvider theme={{ token:{ colorPrimary:'#0f766e', borderRadius:10 } }}>
            <ProLayout
              title='XinChat Admin Pro'
              logo={false}
              layout='mix'
              fixedHeader
              fixSiderbar
              location={{ pathname:path }}
              route={{ path:'/', routes:menus }}
              menuItemRender={(item,dom)=><a onClick={(e)=>{e.preventDefault();setPath(item.path||'/dashboard');}}>{dom}</a>}
              token={{ header:{ colorBgHeader:'rgba(255,255,255,0.9)' } }}
            >
              <PageContainer title={menus.find((m)=>m.path===path)?.name||'Admin'} extra={[<Button key='rd' icon={<ReloadOutlined/>} onClick={loadDash}>刷新概览</Button>]}>
                <Card className='glass' size='small' style={{marginBottom:16}}>
                  <Space wrap>
                    <Input.Password className='mono' placeholder='Admin Token' value={adminToken} onChange={(e)=>setAdminToken(e.target.value)} style={{width:260}} />
                    <Input.Password className='mono' placeholder='Bearer Token (API Lab)' value={authToken} onChange={(e)=>setAuthToken(e.target.value)} style={{width:260}} />
                    <Space><Text type='secondary'>自动刷新(秒)</Text><InputNumber min={5} max={300} value={refreshSec} onChange={(v)=>setRefreshSec(v||15)} /></Space>
                  </Space>
                </Card>
                {page}
              </PageContainer>
            </ProLayout>

            <Modal title='用户编辑' open={userOpen} onCancel={()=>setUserOpen(false)} onOk={saveUser} width={760} okText='保存'>
              <Form form={userForm} layout='vertical'>
                <Row gutter={12}>
                  <Col span={8}><Form.Item label='UID' name='uid'><Input className='mono' disabled /></Form.Item></Col>
                  <Col span={8}><Form.Item label='状态' name='status'><Select options={['active','blocked','deleted'].map(x=>({label:x,value:x}))} /></Form.Item></Col>
                  <Col span={8}><Form.Item label='昵称' name='nickname'><Input maxLength={36} /></Form.Item></Col>
                </Row>
                <Row gutter={12}>
                  <Col span={12}><Form.Item label='签名' name='signature'><Input maxLength={80} /></Form.Item></Col>
                  <Col span={12}><Form.Item label='域名' name='domain'><Input maxLength={253} /></Form.Item></Col>
                </Row>
                <Row gutter={12}>
                  <Col span={8}><Form.Item label='性别' name='gender'><Input /></Form.Item></Col>
                  <Col span={8}><Form.Item label='生日' name='birthday'><Input /></Form.Item></Col>
                  <Col span={8}><Form.Item label='国家' name='country'><Input /></Form.Item></Col>
                </Row>
                <Row gutter={12}>
                  <Col span={12}><Form.Item label='省份' name='province'><Input /></Form.Item></Col>
                  <Col span={12}><Form.Item label='地区' name='region'><Input /></Form.Item></Col>
                </Row>
                {userDetail && <Alert type='info' showIcon message={`好友请求: incoming ${userDetail.friendRequests?.incoming||0}, outgoing ${userDetail.friendRequests?.outgoing||0}`} />}
              </Form>
            </Modal>

            <Drawer title='消息审查' open={msgOpen} onClose={()=>setMsgOpen(false)} width={760} extra={<Button type='primary' onClick={saveMsg}>保存审查</Button>}>
              {msgDetail ? (
                <Space direction='vertical' style={{width:'100%'}} size={16}>
                  <ProDescriptions column={2} bordered dataSource={msgDetail} columns={[{title:'消息ID',dataIndex:'id',copyable:true},{title:'时间',dataIndex:'createdAt',renderText:(v)=>fmtTime(v)},{title:'发送者',dataIndex:'senderUid'},{title:'目标',dataIndex:'targetUid'},{title:'类型',dataIndex:'type'},{title:'会话类型',dataIndex:'targetType'}]} />
                  <Card className='glass' size='small' title='内容摘要'>
                    <Paragraph>{msgDetail.preview || msgDetail.inspection?.textSample || '-'}</Paragraph>
                    {Array.isArray(msgDetail.inspection?.hitRules)&&msgDetail.inspection.hitRules.length>0 && <Space wrap>{msgDetail.inspection.hitRules.map((r)=><Tag key={r.id} color={r.risk==='high'?'red':'orange'}>{r.label}</Tag>)}</Space>}
                  </Card>
                  <Form form={msgForm} layout='vertical'>
                    <Form.Item name='id' hidden><Input /></Form.Item>
                    <Row gutter={12}>
                      <Col span={8}><Form.Item label='审查状态' name='status' rules={[{required:true}]}><Select options={reviewStatus.filter(x=>x!=='unreviewed').map(x=>({label:x,value:x}))} /></Form.Item></Col>
                      <Col span={8}><Form.Item label='风险级别' name='riskLevel' rules={[{required:true}]}><Select options={riskLevels.map(x=>({label:x,value:x}))} /></Form.Item></Col>
                      <Col span={8}><Form.Item label='审核人' name='reviewer'><Input placeholder='ops@xinchat' /></Form.Item></Col>
                    </Row>
                    <Form.Item label='标签(逗号分隔)' name='tags'><Input placeholder='spam,fraud' /></Form.Item>
                    <Form.Item label='审查说明' name='reason'><Input.TextArea rows={4} maxLength={300} /></Form.Item>
                  </Form>
                  <Card className='glass' size='small' title='原始消息数据'><pre className='resp mono'>{JSON.stringify(msgDetail.data||{},null,2)}</pre></Card>
                </Space>
              ) : <Alert type='info' showIcon message='加载中...' />}
            </Drawer>
          </ConfigProvider>
        );
      }

      ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
  </body>
</html>
